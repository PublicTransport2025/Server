# Server
**–°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å** –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –∫–æ–º–ø–ª–µ–∫—Å–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç *–∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö* –∏ *–≤—ã—Å–æ–∫—É—é —Å–∫–æ—Ä–æ—Å—Ç—å* —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ *—Ä–∞–±–æ—Ç–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞* –∏ *–ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤*.

üåê **–í–µ–±-—Å–∞–π—Ç –ø—Ä–æ–µ–∫—Ç–∞**: [transport3ka.ru](https://transport3ka.ru/)

## –ú–æ–¥–µ–ª—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫–∞ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∞—Ö –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞. –ù–∞—à–∞ –º–æ–¥–µ–ª—å –æ–±—É—á–∞–ª–∞—Å—å –Ω–∞ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –æ—Ç –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ ([—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç](https://github.com/PublicTransport2025/Docs/blob/main/%D0%94%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D1%8B%20%D0%B8%20%D1%81%D0%BE%D0%B3%D0%BB%D0%B0%D1%88%D0%B5%D0%BD%D0%B8%D1%8F/%D0%97%D0%B0%D0%BF%D1%80%D0%BE%D1%81%20%D0%B2%20%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D1%82%D1%80%D0%B0%D0%BD%D1%81%D0%BF%D0%BE%D1%80%D1%82%D0%B0.pdf))

## –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

<table align="center" width='100%'>
<tr><td>

![Python](https://img.shields.io/badge/python-3670A0?style=for-the-badge&logo=python&logoColor=ffdd54)

Python 3.12 - –û—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
</td><td>

![FastAPI](https://img.shields.io/badge/FastAPI-005571?style=for-the-badge&logo=fastapi)

–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π WEB-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è Python
</td><td>

![Postgres](https://img.shields.io/badge/postgres-%23316192.svg?style=for-the-badge&logo=postgresql&logoColor=white)

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
</td></tr><table>

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –Ω–∞ —Å–≤–æ–π –∫–æ–º–ø—å—é—Ç–µ—Ä ```git clone https://github.com/PublicTransport2025/Server.git <–ø–∞–ø–∫–∞> ```
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Å–∫–∞—á–µ–Ω–Ω—É—é –ø–∞–ø–∫—É ```cd <–ø–∞–ø–∫–∞> ```
3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é —Å—Ä–µ–¥—É poetry –∏ —Å–∏—Å—Ç–µ–º—É –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–µ—Ä—Å–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ```pip install poetry alembic```
4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–∏–º—ã–µ python –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ```poetry install --no-root```
5. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö PostgreSQL —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞ –∫–∞–∫ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—è –ø—É—Å—Ç–æ–π Docker-–æ–±—Ä–∞–∑
6. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º
```
LOCALHOST=localhost
PORT=80

VERSION=DEBUG
API_KEY=–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–∞—è —Ç–µ–∫—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞

DB_NAME=–ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASS=postgres

WEB_CLIENT_ID=–î–∞–Ω–Ω—ã–µ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –í–ö –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
WEB_CLIENT_SECRET=–î–∞–Ω–Ω—ã–µ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –í–ö –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
WEB_REDIRECT_URI=http://localhost/web/profile/auth


MOBILE_CLIENT_ID=–î–∞–Ω–Ω—ã–µ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –í–ö –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
MOBILE_CLIENT_SECRET=–î–∞–Ω–Ω—ã–µ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –í–ö –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
MOBILE_REDIRECT_URI=vk1234://vk.com/blank.html

ADMIN_VK=VKID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –≤ –ë–î (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)

JWT_SECRET_KEY=–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–∞—è —Ç–µ–∫—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
JWT_ALGORITHM=HS256 #–∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è jwt
ACCESS_TOKEN_EXPIRE_MINUTES=15 #–≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ access —Ç–æ–∫–µ–Ω–∞
REFRESH_TOKEN_EXPIRE_DAYS=90  #–≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ refresh —Ç–æ–∫–µ–Ω–∞

ADMIN_EMAIL=–ü–æ—á—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –≤ –ë–î
ADMIN_PASSWORD=–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –≤ –ë–î

MAP_KEY=–ö–ª—é—á –≤–µ–±-–≤–µ—Ä—Å–∏–∏ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç

SMTP_USER=–ü–æ—á—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞
SMTP_PASSWORD=–ü–∞—Ä–æ–ª—å –ø–æ—á—Ç—ã(–Ω—É–∂–µ–Ω –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

```
7. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö ```poetry run alembic upgrade head```
8. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç —á–µ—Ä–µ–∑ ```poetry run python -m src.main```
9. –ê–≤—Ç–æ—Ä–∏–∑–∏—Ä—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ –í–ö –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
10. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª API –º–æ–∂–Ω–æ –ø–æ —Å—Å—ã–ª–∫–µ ```http://localhost/docs```


## –ó–∞–ø—É—Å–∫ –º–æ–¥–µ–ª–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
–ò–Ω—Ñ–µ—Ä–µ–Ω—Å –º–æ–¥–µ–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫–∞–∫ —Å–µ—Ä–≤–∏—Å –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞.  
üìÅ –ü–∞–ø–∫–∞ —Å —Ñ–∞–π–ª–∞–º–∏ –º–æ–¥–µ–ª–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: [model_ml](https://github.com/PublicTransport2025/Server/tree/main/model_ml)

–§–∞–π–ª—ã, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–æ–¥–µ–ª–∏:  
- `xgboost_model.pkl`  
- `target_encoder.pkl`  
- `unique_route_ids.pkl`  
- `passenger_avg_by_route_hour.pkl`  

–ü—Ä–∏–º–µ—Ä –∫–ª–∞—Å—Å–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞—à–µ–π –º–æ–¥–µ–ª–∏:
```python
import logging
import traceback
from pathlib import Path
from typing import Union

import joblib
import pandas as pd
from fastapi import HTTPException


MODEL_DIR = Path("model_ml")

try:
    xgb_model = joblib.load(MODEL_DIR / "xgboost_model.pkl")
    encoder = joblib.load(MODEL_DIR / "target_encoder.pkl")
    known_route_ids = joblib.load(MODEL_DIR / "unique_route_ids.pkl")
    avg_passengers_stats = joblib.load(MODEL_DIR / "passenger_avg_by_route_hour.pkl")
except Exception as exc:
    msg = '\n'.join(traceback.format_exception(type(exc), exc, exc.__traceback__))
    logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–∏: \n{msg}")
    raise

class MlService:
    @staticmethod
    def get_day_part(hour: int) -> str:
        if 5 <= hour < 10: return '—É—Ç—Ä–æ'
        elif 10 <= hour < 17: return '–¥–µ–Ω—å'
        elif 17 <= hour < 22: return '–≤–µ—á–µ—Ä'
        else: return '–Ω–æ—á—å'

    @staticmethod
    def predict_passengers(data: dict) -> Union[float, str]:
        """
        –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–∞ –≤—Ö–æ–¥ JSON-—Å–ª–æ–≤–∞—Ä—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –ø–æ–µ–∑–¥–∫–∏:
        {
          "route_id": id,
          "order": 1,
          "stop_id": id,
          "–í—Ä–µ–º—è": "06:42:00",
          "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏": "–ü—è—Ç–Ω–∏—Ü–∞"
        }
        """

        try:
            route_id = data["route_id"]
            stop_id = data["stop_id"]

            if route_id not in known_route_ids:
                return f"route_id {route_id} –Ω–µ –æ–±—É—á–µ–Ω –≤ –º–æ–¥–µ–ª–∏"

            time = pd.to_datetime(data["–í—Ä–µ–º—è"], format="%H:%M:%S")
            hour = time.hour
            minute = time.minute
            time_minutes = hour * 60 + minute
            day_part = MlService.get_day_part(hour)
            avg_val = avg_passengers_stats.get((route_id, hour), 0)

            features = {
                "route_id": route_id,
                "order": data["order"],
                "stop_id": stop_id,
                "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏": data["–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏"],
                "hour": hour,
                "minute": minute,
                "time_minutes": time_minutes,
                "day_part": day_part,
                "route_stop": f"{route_id}_{stop_id}",
                "avg_passengers_route_hour": avg_val
            }

            df = pd.DataFrame([features])

            column_order = [
                "route_id", "order", "stop_id", "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏", "hour",
                "minute", "time_minutes", "day_part", "route_stop", "avg_passengers_route_hour"
            ]

            df = df[column_order]
            df_encoded = encoder.transform(df)

            prediction = xgb_model.predict(df_encoded)[0]

            return round(float(prediction), 2)

        except Exception as exc:
            msg = '\n'.join(traceback.format_exception(type(exc), exc, exc.__traceback__))
            logging.error(msg)
            raise HTTPException(500, detail="–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–æ–¥–µ–ª–∏")
```

## –ö–æ–¥-—Å—Ç–∞–π–ª
1. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
   * –í–µ—Ä—Å–∏—è Python 3.12
   * –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–µ—Ä—Å–∏–π Poetry
   * ORM –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
   * –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–∏—Å–æ–≤
2. –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∫–æ–¥–∞:
   * –ù–∞–∑–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö ```snake_case```, –∫–ª–∞—Å—Å–æ–≤ ```CamelCase```, –∫–æ–Ω—Å—Ç–∞–Ω—Ç ```UPPER_CASE```
   * –†–∞–∑–º–µ—Ä —Ç–∞–±—É–ª—è—Ü–∏–∏ - 4 –ø—Ä–æ–±–µ–ª–∞
   * –ö–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
   * –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ñ–æ—Ä–º–ª—è—é—Ç—Å—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
   * –õ–æ–≥–∏–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
3. –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–æ–≤:
   * –§–æ—Ä–º–∞—Ç –∫–æ–º–º–∏—Ç–∞ task-number: description
   * –ö–æ–º–º–∏—Ç—ã –æ—Ñ–æ—Ä–º–ª—è—é—Ç—Å—è –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ
   * –ù–æ–º–µ—Ä –∏ —Ç–∏–ø –∑–∞–¥–∞—á –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–∞—Å–∫-—Ç—Ä–µ–∫–µ—Ä—É
   * –ù–∞–∑–≤–∞–Ω–∏—è –≤–µ—Ç–æ–∫: ```main``` ```release``` ```dev``` ```feature``` ```fix```
